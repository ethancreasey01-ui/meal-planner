<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#F5F5F7">
    <title>Meal Planner</title>
    <style>
        /* ============================================
           APPLE DESIGN SYSTEM - MEAL PLANNER
           ============================================ */
        
        :root {
            /* iOS Colors */
            --ios-blue: #007AFF;
            --ios-blue-light: #5AC8FA;
            --ios-orange: #FF9500;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-purple: #AF52DE;
            --ios-teal: #5AC8FA;
            --ios-yellow: #FFCC00;
            --ios-pink: #FF2D55;
            --ios-indigo: #5856D6;
            
            /* System Grays */
            --gray1: #8E8E93;
            --gray2: #AEAEB2;
            --gray3: #C7C7CC;
            --gray4: #D1D1D6;
            --gray5: #E5E5EA;
            --gray6: #F2F2F7;
            
            /* Backgrounds */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F7;
            --bg-tertiary: #EFEFF4;
            
            /* Text */
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: rgba(60, 60, 67, 0.6);
            --text-quaternary: rgba(60, 60, 67, 0.3);
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* Animation */
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 24px 80px rgba(0, 0, 0, 0.16);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background: var(--bg-secondary);
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.47059;
            letter-spacing: -0.022em;
        }

        .app-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100vh;
            height: 100dvh;
            gap: 0;
            overflow: hidden;
        }

        /* Left Panel - Recipe Library */
        .recipe-panel {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-right: 0.5px solid var(--gray4);
            display: flex;
            flex-direction: column;
            z-index: 100;
            height: 100vh;
            overflow: hidden;
        }

        .panel-header {
            padding: var(--space-lg);
            padding-top: calc(var(--space-lg) + env(safe-area-inset-top, 0px));
            border-bottom: 0.5px solid var(--gray4);
            flex-shrink: 0;
        }

        .panel-header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.021em;
            margin-bottom: var(--space-xs);
            background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel-header p {
            font-size: 15px;
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .tab-nav {
            display: flex;
            padding: var(--space-md) var(--space-lg);
            gap: 4px;
            border-bottom: 0.5px solid var(--gray4);
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: var(--bg-tertiary);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.3s var(--ease-smooth);
            border-radius: var(--radius-full);
        }

        .tab-btn:hover {
            background: var(--gray5);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-primary);
            color: var(--ios-blue);
            box-shadow: var(--shadow-sm);
        }

        .search-box {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 0.5px solid var(--gray4);
            flex-shrink: 0;
            position: relative;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 36px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            font-size: 15px;
            font-family: inherit;
            color: var(--text-primary);
            transition: all 0.2s var(--ease-smooth);
        }

        .search-box input::placeholder {
            color: var(--text-quaternary);
        }

        .search-box input:focus {
            outline: none;
            background: var(--bg-primary);
            box-shadow: inset 0 0 0 2px var(--ios-blue);
        }

        .recipe-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-md);
            min-height: 0;
        }

        .recipe-list::-webkit-scrollbar {
            width: 6px;
        }

        .recipe-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .recipe-list::-webkit-scrollbar-thumb {
            background: var(--gray4);
            border-radius: 3px;
        }

        .grocery-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-md);
            min-height: 0;
        }

        .grocery-header {
            background: linear-gradient(135deg, var(--ios-orange) 0%, var(--ios-red) 100%);
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .grocery-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            border-radius: 50%;
        }

        .grocery-header h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .grocery-header p {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .grocery-item {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            border: 2px solid transparent;
            transition: all 0.3s var(--ease-spring);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .grocery-item:hover {
            border-color: var(--ios-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .grocery-item.selected {
            border-color: var(--ios-blue);
            background: linear-gradient(135deg, rgba(0,122,255,0.05) 0%, rgba(175,82,222,0.05) 100%);
        }

        .grocery-item h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--text-primary);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 14px;
            border-bottom: 0.5px solid var(--gray5);
        }

        .price-row:last-child {
            border-bottom: none;
        }

        .price-store {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .price-store.coles {
            color: var(--ios-red);
        }

        .price-store.woolies {
            color: var(--ios-green);
        }

        .price-value {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .price-value.special {
            color: var(--ios-red);
        }

        .savings-badge {
            background: var(--ios-green);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 10px;
            font-weight: 700;
        }

        .price-value {
            font-weight: 700;
        }

        .price-value.special {
            color: #e31e24;
        }

        .savings-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .grocery-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-grocery {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-grocery:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-grocery:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .last-updated {
            text-align: center;
            font-size: 0.75rem;
            color: #999;
            margin-top: 10px;
        }

        .recipe-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            cursor: grab;
            transition: all 0.3s var(--ease-spring);
            border: 0.5px solid transparent;
            position: relative;
            user-select: none;
            touch-action: none;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .recipe-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--ios-orange), var(--ios-red));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .recipe-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-lg);
            border-color: var(--gray4);
        }

        .recipe-card:hover::before {
            opacity: 1;
        }

        .recipe-card:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .recipe-card.favorite {
            border-color: #FFD700;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3), var(--shadow-md);
        }

        .recipe-card.favorite::before {
            opacity: 1;
            background: linear-gradient(90deg, #FFD700, #FFA500);
        }

        .favorite-btn {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .favorite-btn:hover {
            transform: scale(1.15);
        }

        .favorite-btn:active {
            transform: scale(0.9);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .meal-item {
            animation: popIn 0.3s ease;
        }

        .recipe-card.dragging {
            opacity: 0.9;
            cursor: grabbing;
            transform: scale(1.05) rotate(1deg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            position: relative;
        }

        .recipe-card h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
            line-height: 1.3;
        }

        .recipe-meta {
            display: flex;
            gap: var(--space-md);
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: var(--space-sm);
        }

        .recipe-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .recipe-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            background: var(--bg-secondary);
            color: var(--ios-blue);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .tag.high-protein { color: var(--ios-orange); }
        .tag.meal-prep { color: var(--ios-green); }
        .tag.quick { color: var(--ios-purple); }

        .recipe-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-sm);
        }

        /* Main Content - Calendar */
        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            padding: var(--space-md) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.5px solid var(--gray4);
            flex-shrink: 0;
            height: 64px;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .week-nav button {
            background: var(--bg-tertiary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s var(--ease-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .week-nav button:hover {
            background: var(--ios-blue);
            color: white;
            transform: scale(1.05);
        }

        .week-nav h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.021em;
        }

        .servings-selector {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--bg-primary);
            padding: 6px 14px;
            border-radius: var(--radius-full);
            border: 0.5px solid var(--gray4);
            box-shadow: var(--shadow-sm);
        }

        .servings-selector label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .servings-selector input {
            width: 44px;
            padding: 4px 8px;
            border: none;
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: var(--ios-blue);
            background: var(--bg-tertiary);
        }

        .servings-selector input:focus {
            outline: none;
            background: var(--bg-secondary);
            box-shadow: inset 0 0 0 2px var(--ios-blue);
        }

        .actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn {
            padding: 10px 18px;
            border-radius: var(--radius-full);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s var(--ease-smooth);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--gray5);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--ios-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-primary:hover {
            background: #0051D5;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }

        /* Calendar Grid */
        .calendar-container {
            flex: 1;
            padding: 15px;
            overflow: auto;
            min-height: 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(160px, 1fr));
            gap: var(--space-md);
            min-width: 1100px;
            height: 100%;
            padding: var(--space-md);
        }

        .day-column {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s var(--ease-spring);
            border: 0.5px solid var(--gray5);
        }

        .day-column:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--gray4);
        }

        .day-header {
            padding: var(--space-md);
            text-align: center;
            border-bottom: 0.5px solid var(--gray5);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .day-header .day-name {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 600;
        }

        .day-header .day-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 4px;
            letter-spacing: -0.021em;
        }

        .day-header.today {
            background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%);
        }

        .day-header.today .day-name,
        .day-header.today .day-number {
            color: white;
        }

        .meal-slots {
            padding: var(--space-md);
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            overflow-y: auto;
        }

        .meal-slot {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 90px;
        }

        .meal-slot .drop-zone {
            flex: 1;
        }

        .meal-slot {
            margin-bottom: var(--space-md);
        }

        .meal-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .drop-zone {
            min-height: 80px;
            border: 2px dashed var(--gray4);
            border-radius: var(--radius-lg);
            padding: var(--space-sm);
            transition: all 0.3s var(--ease-smooth);
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: var(--bg-secondary);
        }

        .drop-zone:hover {
            border-color: var(--gray3);
            background: var(--gray6);
        }

        .drop-zone.drag-over {
            border-color: var(--ios-blue);
            border-style: solid;
            background: linear-gradient(135deg, rgba(0,122,255,0.05) 0%, rgba(175,82,222,0.05) 100%);
            box-shadow: inset 0 0 0 2px rgba(0, 122, 255, 0.15);
            transform: scale(1.02);
        }

        .drop-zone .placeholder {
            text-align: center;
            color: var(--gray3);
            font-size: 13px;
            padding: 24px 0;
        }

        .meal-item {
            background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%);
            color: white;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: grab;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s var(--ease-spring);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
            user-select: none;
        }

        .meal-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.35);
        }

        .meal-item.dragging {
            transform: scale(1.05) rotate(1deg);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
        }

        .meal-item .remove {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .meal-item .remove:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }

        /* Daily Macros */
        .daily-macros {
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 0.5px dashed var(--gray4);
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            justify-content: space-around;
        }

        .daily-macro-item {
            text-align: center;
        }

        .daily-macro-value {
            font-weight: 700;
            color: var(--ios-blue);
            font-size: 12px;
        }

        /* Macro Summary - Weekly */
        .macro-panel {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid var(--gray4);
            padding: var(--space-lg) var(--space-xl);
            flex-shrink: 0;
            height: auto;
            min-height: 130px;
        }

        .macro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .macro-header h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
        }

        .macro-card {
            background: var(--bg-primary);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 0.5px solid var(--gray5);
            transition: all 0.3s var(--ease-spring);
        }

        .macro-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .macro-card.highlight {
            background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%);
            color: white;
            border-color: transparent;
        }

        .macro-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.021em;
        }

        .macro-label {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-weight: 500;
        }

        .macro-card.highlight .macro-label {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Recipe Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-smooth);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.4s var(--ease-spring);
            box-shadow: 0 32px 80px rgba(0, 0, 0, 0.4);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%);
            color: white;
            padding: var(--space-xl);
            position: relative;
        }

        .modal-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .modal-video {
            width: 100%;
            max-height: 400px;
            display: block;
            background: #000;
        }

        .video-download-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: var(--ios-blue);
            color: white;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
        }

        .video-download-progress.spinner::after {
            content: '';
            width: 16px;
            height: 16px;
            margin-left: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: var(--space-xs);
            letter-spacing: -0.021em;
        }

        .modal-header .recipe-source {
            opacity: 0.9;
            font-size: 15px;
            font-weight: 500;
        }

        .modal-close {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease-smooth);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.1);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .modal-section {
            margin-bottom: var(--space-xl);
        }

        .modal-section h4 {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--ios-blue);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .ingredients-list {
            list-style: none;
        }

        .ingredients-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .ingredients-list li:last-child {
            border-bottom: none;
        }

        .directions-list {
            list-style: decimal;
            padding-left: 20px;
        }

        .directions-list li {
            padding: 10px 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .modal-macros {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
        }

        .modal-macro-item {
            text-align: center;
        }

        .modal-macro-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #667eea;
        }

        .modal-macro-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }

        .recipe-link {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .recipe-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        
        /* Mobile Bottom Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
        }
        
        .mobile-nav-item.active {
            color: #667eea;
            background: #f0f4ff;
        }
        
        .mobile-nav-item span:first-child {
            font-size: 1.4rem;
        }
        
        /* Mobile Calendar Day Swiper */
        .mobile-day-swiper {
            display: none;
            background: white;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .day-swiper-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 5px;
        }
        
        .day-swiper-container::-webkit-scrollbar {
            display: none;
        }
        
        .day-swiper-item {
            flex: 0 0 auto;
            scroll-snap-align: start;
            padding: 10px 16px;
            background: #f8f9fa;
            border-radius: 12px;
            text-align: center;
            min-width: 60px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .day-swiper-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .day-swiper-item .day-name {
            font-size: 0.65rem;
            text-transform: uppercase;
            opacity: 0.8;
        }
        
        .day-swiper-item .day-number {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* Mobile Recipe Panel Toggle */
        .mobile-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mobile-panel-overlay.active {
            opacity: 1;
        }
        
        .recipe-panel.mobile-open {
            transform: translateX(0);
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) {
            .recipe-card:hover {
                transform: none;
            }
            
            .btn:hover, .btn-grocery:hover {
                transform: none;
            }
            
            .day-column:hover {
                transform: none;
            }
        }
        
        /* Responsive Breakpoints */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 260px 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, minmax(120px, 1fr));
                gap: 8px;
            }
            
            .day-column {
                min-height: 350px;
            }
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 240px 1fr;
            }
            
            .recipe-card {
                padding: 12px;
            }
            
            .recipe-card h3 {
                font-size: 0.85rem;
            }
            
            .day-header .day-number {
                font-size: 1.2rem;
            }
            
            .meal-label {
                font-size: 0.7rem;
            }
        }

        /* Mobile Layout - Up to 768px */
        @media (max-width: 768px) {
            body {
                overflow: auto;
                height: auto;
                min-height: 100vh;
                padding-bottom: 80px; /* Space for bottom nav */
            }
            
            .app-container {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            /* Mobile Navigation */
            .mobile-nav {
                display: block;
            }
            
            /* Recipe Panel - Slide out from left */
            .recipe-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                z-index: 1001;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            }
            
            .recipe-panel.mobile-open {
                transform: translateX(0);
            }
            
            .mobile-panel-overlay {
                display: block;
            }
            
            .mobile-panel-overlay.active {
                opacity: 1;
            }
            
            /* Main Content */
            .main-content {
                height: auto;
                min-height: 100vh;
            }
            
            /* Toolbar - Stack on mobile */
            .toolbar {
                flex-wrap: wrap;
                gap: 10px;
                height: auto;
                padding: 12px 15px;
            }
            
            .week-nav {
                order: 1;
                width: 100%;
                justify-content: center;
            }
            
            .week-nav h2 {
                font-size: 1.1rem;
            }
            
            .servings-selector {
                order: 2;
                flex: 1;
                justify-content: center;
            }
            
            .actions {
                order: 3;
                width: 100%;
                justify-content: center;
                gap: 8px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 0.8rem;
                flex: 1;
                justify-content: center;
            }
            
            /* Mobile Day Swiper */
            .mobile-day-swiper {
                display: block;
            }
            
            /* Calendar - Single column on mobile */
            .calendar-container {
                padding: 10px;
                overflow: visible;
            }
            
            .calendar-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
                min-width: auto;
            }
            
            .day-column {
                min-height: auto;
                border-radius: 16px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            }
            
            .day-header {
                padding: 12px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .day-header .day-name {
                font-size: 0.9rem;
            }
            
            .day-header .day-number {
                font-size: 1.5rem;
            }
            
            .meal-slots {
                padding: 15px;
                gap: 15px;
            }
            
            .meal-slot {
                min-height: auto;
            }
            
            .meal-label {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }
            
            .drop-zone {
                min-height: 80px;
                padding: 12px;
            }
            
            .meal-item {
                padding: 12px 14px;
                font-size: 0.95rem;
            }
            
            .meal-item .remove {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            
            /* Daily Macros */
            .daily-macros {
                padding: 12px 15px;
                font-size: 0.8rem;
            }
            
            /* Macro Panel */
            .macro-panel {
                padding: 15px;
                margin-bottom: 80px;
            }
            
            .macro-header h3 {
                font-size: 0.95rem;
            }
            
            .macro-grid {
                gap: 10px;
            }
            
            .macro-card {
                padding: 15px 10px;
            }
            
            .macro-value {
                font-size: 1.3rem;
            }
            
            .macro-label {
                font-size: 0.75rem;
            }
            
            /* Recipe Cards - Larger touch targets */
            .recipe-card {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .recipe-card h3 {
                font-size: 1rem;
            }
            
            .recipe-meta {
                font-size: 0.85rem;
            }
            
            /* Modal - Full screen on mobile */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                border-radius: 20px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .modal-header h2 {
                font-size: 1.3rem;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-macros {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .modal-macro-value {
                font-size: 1.5rem;
            }
            
            /* Grocery list improvements */
            .grocery-item {
                padding: 16px;
            }
            
            .grocery-item h4 {
                font-size: 1rem;
            }
            
            .price-row {
                font-size: 0.95rem;
                padding: 8px 0;
            }
            
            .btn-grocery {
                padding: 14px;
                font-size: 1rem;
            }
        }
        
        /* Small phones */
        @media (max-width: 380px) {
            .toolbar {
                padding: 10px;
            }
            
            .week-nav h2 {
                font-size: 1rem;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            
            .day-swiper-item {
                min-width: 55px;
                padding: 8px 12px;
            }
            
            .macro-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Mobile Panel Overlay -->
    <div class="mobile-panel-overlay" id="mobilePanelOverlay" onclick="closeMobilePanel()"></div>
    
    <div class="app-container">
        <!-- Left Panel - Recipe Library -->
        <div class="recipe-panel" id="recipePanel">
            <div class="panel-header">
                <h1>üçΩÔ∏è Meal Planner</h1>
                <p>Plan meals & manage staples</p>
            </div>
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('recipes')" id="tab-recipes">üçΩÔ∏è Recipes</button>
                <button class="tab-btn" onclick="switchTab('groceries')" id="tab-groceries">üìã Everyday Items</button>
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search..." id="searchInput">
            </div>
            <div style="padding: 0 var(--space-md) var(--space-md);">
                <button id="favoritesFilterBtn" class="btn btn-secondary" onclick="toggleFavoritesFilter()" style="width: 100%; font-size: 0.85rem;">
                    ‚òÜ Show Favorites
                </button>
            </div>
            <div class="recipe-list" id="recipeList">
                <!-- Recipes injected here -->
            </div>
            <div class="grocery-list" id="groceryList" style="display: none;">
                <!-- Grocery specials injected here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="toolbar">
                <div class="week-nav">
                    <button onclick="changeWeek(-1)">‚óÄ</button>
                    <h2 id="weekDisplay">This Week</h2>
                    <button onclick="changeWeek(1)">‚ñ∂</button>
                </div>
                <div class="servings-selector">
                    <label for="servingsInput">üë• Servings:</label>
                    <input type="number" id="servingsInput" value="1" min="1" max="20" onchange="updateServings()">
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="clearWeek()">üóëÔ∏è Clear Week</button>
                    <button class="btn btn-secondary" onclick="clearAllReminders()" title="Clear Apple Reminders lists">üßπ Clear Reminders</button>
                    <button class="btn btn-secondary" onclick="generateRandomMealPlan()" title="Auto-generate random meal plan">üé≤ Generate Plan</button>
                    <button class="btn btn-primary" onclick="generateShoppingList()">
                        üõí Shopping List
                    </button>
                </div>
            </div>

            <!-- Mobile Day Swiper -->
            <div class="mobile-day-swiper">
                <div class="day-swiper-container" id="daySwiper">
                    <!-- Day swiper items injected here -->
                </div>
            </div>
            
            <div class="calendar-container">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Days injected here -->
                </div>
            </div>

            <div class="macro-panel">
                <div class="macro-header">
                    <h3>üìä Weekly Macro Summary</h3>
                    <span id="mealCount">0 meals planned</span>
                </div>
                <div class="macro-grid">
                    <div class="macro-card highlight">
                        <div class="macro-value" id="totalCalories">0</div>
                        <div class="macro-label">calories / day</div>
                    </div>
                    <div class="macro-card">
                        <div class="macro-value" id="totalProtein">0g</div>
                        <div class="macro-label">protein / day</div>
                    </div>
                    <div class="macro-card">
                        <div class="macro-value" id="totalCarbs">0g</div>
                        <div class="macro-label">carbs / day</div>
                    </div>
                    <div class="macro-card">
                        <div class="macro-value" id="totalFat">0g</div>
                        <div class="macro-label">fat / day</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" onclick="switchMobileView('calendar')" id="nav-calendar">
                <span>üìÖ</span>
                <span>Calendar</span>
            </button>
            <button class="mobile-nav-item" onclick="switchMobileView('recipes')" id="nav-recipes">
                <span>üçΩÔ∏è</span>
                <span>Recipes</span>
            </button>
            <button class="mobile-nav-item" onclick="switchMobileView('groceries')" id="nav-groceries">
                <span>üìã</span>
                <span>Items</span>
            </button>
            <button class="mobile-nav-item" onclick="generateShoppingList()" id="nav-shopping">
                <span>üìã</span>
                <span>List</span>
            </button>
        </div>
    </nav>

    <!-- Recipe Detail Modal -->
    <div class="modal-overlay" id="recipeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Recipe Name</h2>
                <div class="recipe-source" id="modalSource">Source: TikTok</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <img id="modalImage" class="modal-image" src="" alt="Recipe Image" style="display: none;">
            
            <!-- Video Section -->
            <div id="modalVideoSection" style="display: none;">
                <video id="modalVideo" class="modal-video" controls playsinline poster="">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            
            <div class="modal-body">
                <div class="modal-section" id="modalLinkSection" style="display: none;">
                    <h4>üîó Recipe Source</h4>
                    <a href="#" id="modalLink" target="_blank" class="recipe-link">View Original Recipe ‚Üí</a>
                    <div id="videoDownloadSection" style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div id="videoDownloadStatus">
                            <button class="btn btn-secondary" onclick="downloadRecipeVideo()" style="width: 100%;">
                                üì• Download Video
                            </button>
                            <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px; text-align: center;">
                                Save locally so you never lose this recipe
                            </p>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>üìä Macros (per serving)</h4>
                    <div class="modal-macros" id="modalMacros">
                        <div class="modal-macro-item">
                            <div class="modal-macro-value">394</div>
                            <div class="modal-macro-label">calories</div>
                        </div>
                        <div class="modal-macro-item">
                            <div class="modal-macro-value">43g</div>
                            <div class="modal-macro-label">protein</div>
                        </div>
                        <div class="modal-macro-item">
                            <div class="modal-macro-value">27g</div>
                            <div class="modal-macro-label">carbs</div>
                        </div>
                        <div class="modal-macro-item">
                            <div class="modal-macro-value">17g</div>
                            <div class="modal-macro-label">fat</div>
                        </div>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>üìù Ingredients</h4>
                    <ul class="ingredients-list" id="modalIngredients">
                        <!-- Ingredients injected here -->
                    </ul>
                </div>
                <div class="modal-section">
                    <h4>üë®‚Äçüç≥ Directions</h4>
                    <ol class="directions-list" id="modalDirections">
                        <!-- Directions injected here -->
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample recipe data
        const recipes = [
            {
                id: 1,
                name: "üåØ Cheesy Chicken Fajita Wraps",
                image: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?w=400&h=300&fit=crop",
                calories: 394,
                protein: 43,
                carbs: 27,
                fat: 17,
                servings: 10,
                tags: ["high protein", "meal prep"],
                source: "TikTok @mealprepking",
                url: "https://www.tiktok.com/@mealprepking/video/1234567890",
                ingredients: [
                    { name: "Chicken Thighs", amount: 160, unit: "g", perServing: true },
                    { name: "Red Onion", amount: 20, unit: "g", perServing: true },
                    { name: "White Onion", amount: 20, unit: "g", perServing: true },
                    { name: "Bell Peppers", amount: 45, unit: "g", perServing: true },
                    { name: "Cheddar Cheese", amount: 10, unit: "g", perServing: true },
                    { name: "Mozzarella", amount: 10, unit: "g", perServing: true },
                    { name: "Tortilla Wraps", amount: 1, unit: "pc", perServing: true },
                    { name: "Yogurt", amount: 15, unit: "g", perServing: true },
                    { name: "Mayo", amount: 8, unit: "g", perServing: true }
                ],
                directions: [
                    "Cube chicken thighs and season with fajita seasoning, olive oil, and lime juice",
                    "Line sheet pan with baking paper, add onions and peppers, season and roast at 190C for 20 mins",
                    "Spread marinated chicken over vegetables, bake at 200C for 25-30 mins until golden",
                    "Add cheese, tomatoes, and coriander while hot, mix until melted",
                    "Serve with wraps and spicy sauce"
                ]
            },
            {
                id: 2,
                name: "üåØ Korean BBQ Chicken Wraps",
                image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=300&fit=crop",
                calories: 417,
                protein: 39,
                carbs: 38,
                fat: 12,
                servings: 10,
                tags: ["korean", "sheet pan", "meal prep"],
                source: "TikTok @mealprepking",
                url: "https://vt.tiktok.com/ZSasCnndj/",
                ingredients: [
                    { name: "Chicken Thighs", amount: 160, unit: "g", perServing: true },
                    { name: "Gochujang Paste", amount: 10, unit: "g", perServing: true },
                    { name: "Minced Garlic", amount: 6, unit: "g", perServing: true },
                    { name: "Sesame Seeds", amount: 4, unit: "g", perServing: true },
                    { name: "Honey", amount: 6, unit: "g", perServing: true },
                    { name: "Light Soy Sauce", amount: 3, unit: "g", perServing: true },
                    { name: "Dark Soy Sauce", amount: 4, unit: "g", perServing: true },
                    { name: "Low Fat Yogurt", amount: 20, unit: "g", perServing: true },
                    { name: "Light Mayo", amount: 12, unit: "g", perServing: true },
                    { name: "Cucumber", amount: 30, unit: "g", perServing: true },
                    { name: "Grated Carrots", amount: 20, unit: "g", perServing: true },
                    { name: "Red Onion", amount: 20, unit: "g", perServing: true },
                    { name: "Rice Vinegar", amount: 4, unit: "g", perServing: true },
                    { name: "Sriracha", amount: 3, unit: "g", perServing: true },
                    { name: "Low Carb Flour Wraps", amount: 1, unit: "pc", perServing: true }
                ],
                directions: [
                    "Trim excess fat from chicken thighs, add seasonings and marinade ingredients then mix and set aside",
                    "In a bowl, add cucumber, carrots, red onion, sesame seeds, rice vinegar and sriracha. Mix until well combined",
                    "In a second bowl, add yogurt, light mayo, gochujang, honey, garlic powder and milk for desired consistency",
                    "In a lined large sheet pan, spread marinated chicken evenly. Add cooking spray, oven bake 25-30 mins at 200C / 400F until golden!",
                    "Toast wraps in a stove flame, slice up chicken then serve with cucumber slaw and gochujang sauce. ENJOY!"
                ]
            },
            {
                id: 3,
                name: "üçö Oyakodon (Chicken & Egg Rice Bowl)",
                image: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?w=400&h=300&fit=crop",
                calories: 485,
                protein: 38,
                carbs: 52,
                fat: 14,
                servings: 4,
                tags: ["japanese", "comfort food", "rice bowl"],
                source: "TikTok @japanesefoodie",
                url: "https://www.tiktok.com/@japanesefoodie/video/oyakodon",
                ingredients: [
                    { name: "Chicken Thighs", amount: 200, unit: "g", perServing: true },
                    { name: "Eggs", amount: 2, unit: "pc", perServing: true },
                    { name: "Onion", amount: 80, unit: "g", perServing: true },
                    { name: "Dashi Stock", amount: 60, unit: "ml", perServing: true },
                    { name: "Soy Sauce", amount: 15, unit: "ml", perServing: true },
                    { name: "Mirin", amount: 15, unit: "ml", perServing: true },
                    { name: "Sugar", amount: 5, unit: "g", perServing: true },
                    { name: "Cooked Rice", amount: 200, unit: "g", perServing: true },
                    { name: "Green Onions", amount: 10, unit: "g", perServing: true }
                ],
                directions: [
                    "Slice chicken and onion into bite-sized pieces",
                    "In a pan, combine dashi, soy sauce, mirin, and sugar. Bring to a simmer",
                    "Add onions and cook for 2-3 minutes until softened",
                    "Add chicken and cook until no longer pink",
                    "Pour beaten eggs evenly over the chicken, cover and cook for 1-2 minutes",
                    "Slide the finished oyakodon over a bowl of rice, garnish with green onions"
                ]
            },
            {
                id: 4,
                name: "üçî Baconnaise Double Cheeseburgers",
                image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=300&fit=crop",
                calories: 650,
                protein: 42,
                carbs: 35,
                fat: 38,
                servings: 4,
                tags: ["burger", "american", "comfort food"],
                source: "TikTok @burgerking",
                url: "https://www.tiktok.com/@burgerking/video/baconnaise",
                ingredients: [
                    { name: "Ground Beef", amount: 200, unit: "g", perServing: true },
                    { name: "Bacon", amount: 60, unit: "g", perServing: true },
                    { name: "Cheddar Cheese", amount: 40, unit: "g", perServing: true },
                    { name: "Burger Buns", amount: 1, unit: "pc", perServing: true },
                    { name: "Mayo", amount: 20, unit: "g", perServing: true },
                    { name: "Lettuce", amount: 20, unit: "g", perServing: true },
                    { name: "Tomato", amount: 30, unit: "g", perServing: true },
                    { name: "Pickles", amount: 15, unit: "g", perServing: true },
                    { name: "Onion", amount: 20, unit: "g", perServing: true }
                ],
                directions: [
                    "Form beef into patties, season with salt and pepper",
                    "Cook bacon until crispy, set aside",
                    "Grill or pan-sear burger patties over high heat for 3-4 mins per side",
                    "Add cheese in the last minute to melt",
                    "Toast buns until golden",
                    "Mix mayo with bacon bits for 'baconnaise' sauce",
                    "Assemble burgers with sauce, lettuce, tomato, pickles, onion, patties, and bacon"
                ]
            },
            {
                id: 5,
                name: "ü•î Mediterranean Roast Potatoes with Chicken",
                image: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?w=400&h=300&fit=crop",
                calories: 520,
                protein: 35,
                carbs: 48,
                fat: 22,
                servings: 6,
                tags: ["mediterranean", "sheet pan", "healthy"],
                source: "TikTok @mediterraneandiet",
                url: "https://www.tiktok.com/@mediterraneandiet/video/roast",
                ingredients: [
                    { name: "Chicken Thighs", amount: 180, unit: "g", perServing: true },
                    { name: "Potatoes", amount: 250, unit: "g", perServing: true },
                    { name: "Cherry Tomatoes", amount: 80, unit: "g", perServing: true },
                    { name: "Red Onion", amount: 40, unit: "g", perServing: true },
                    { name: "Garlic", amount: 10, unit: "g", perServing: true },
                    { name: "Lemon", amount: 0.5, unit: "pc", perServing: true },
                    { name: "Olive Oil", amount: 15, unit: "ml", perServing: true },
                    { name: "Dried Oregano", amount: 2, unit: "g", perServing: true },
                    { name: "Feta Cheese", amount: 30, unit: "g", perServing: true },
                    { name: "Kalamata Olives", amount: 20, unit: "g", perServing: true }
                ],
                directions: [
                    "Preheat oven to 200C / 400F",
                    "Cut potatoes into wedges, toss with olive oil, oregano, salt, and pepper",
                    "Roast potatoes for 20 minutes",
                    "Add chicken thighs, tomatoes, onion, and garlic to the pan",
                    "Squeeze lemon juice over everything, roast for another 25-30 mins",
                    "Top with crumbled feta and olives before serving"
                ]
            },
            {
                id: 6,
                name: "üçù Crispy Peri Peri Chicken & Bacon Pasta Salad",
                image: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?w=400&h=300&fit=crop",
                calories: 580,
                protein: 40,
                carbs: 55,
                fat: 24,
                servings: 6,
                tags: ["pasta salad", "meal prep", "spicy"],
                source: "TikTok @pastalover",
                url: "https://www.tiktok.com/@pastalover/video/periperi",
                ingredients: [
                    { name: "Chicken Breast", amount: 170, unit: "g", perServing: true },
                    { name: "Bacon", amount: 50, unit: "g", perServing: true },
                    { name: "Pasta", amount: 80, unit: "g", perServing: true },
                    { name: "Cherry Tomatoes", amount: 60, unit: "g", perServing: true },
                    { name: "Cucumber", amount: 40, unit: "g", perServing: true },
                    { name: "Red Onion", amount: 25, unit: "g", perServing: true },
                    { name: "Mayo", amount: 25, unit: "g", perServing: true },
                    { name: "Peri Peri Sauce", amount: 20, unit: "g", perServing: true },
                    { name: "Lemon Juice", amount: 10, unit: "ml", perServing: true },
                    { name: "Parmesan", amount: 15, unit: "g", perServing: true }
                ],
                directions: [
                    "Cook pasta according to package directions, rinse with cold water",
                    "Season chicken with peri peri spice, cook until crispy and golden",
                    "Cook bacon until crispy, crumble into bits",
                    "Chop tomatoes, cucumber, and red onion",
                    "Mix mayo, peri peri sauce, and lemon juice for dressing",
                    "Toss pasta with vegetables, chicken, bacon, dressing, and parmesan"
                ]
            },
            {
                id: 7,
                name: "üçî Crispy Chicken Bacon Burgers",
                image: "https://images.unsplash.com/photo-1586190848861-99aa4a171e90?w=400&h=300&fit=crop",
                calories: 620,
                protein: 44,
                carbs: 42,
                fat: 28,
                servings: 4,
                tags: ["burger", "crispy", "comfort food"],
                source: "TikTok @chickenrecipes",
                url: "https://www.tiktok.com/@chickenrecipes/video/crispy",
                ingredients: [
                    { name: "Chicken Thighs", amount: 220, unit: "g", perServing: true },
                    { name: "Bacon", amount: 50, unit: "g", perServing: true },
                    { name: "Burger Buns", amount: 1, unit: "pc", perServing: true },
                    { name: "Flour", amount: 30, unit: "g", perServing: true },
                    { name: "Eggs", amount: 0.5, unit: "pc", perServing: true },
                    { name: "Breadcrumbs", amount: 40, unit: "g", perServing: true },
                    { name: "Lettuce", amount: 20, unit: "g", perServing: true },
                    { name: "Tomato", amount: 30, unit: "g", perServing: true },
                    { name: "Mayo", amount: 20, unit: "g", perServing: true },
                    { name: "BBQ Sauce", amount: 15, unit: "g", perServing: true }
                ],
                directions: [
                    "Flatten chicken thighs slightly for even cooking",
                    "Dredge chicken in flour, then egg, then breadcrumbs",
                    "Fry chicken in oil until golden and crispy, about 4-5 mins per side",
                    "Cook bacon until crispy",
                    "Toast buns and spread with mayo",
                    "Assemble burgers with lettuce, tomato, crispy chicken, bacon, and BBQ sauce"
                ]
            },
            {
                id: 8,
                name: "üçú Chicken Pad Thai",
                image: "https://images.unsplash.com/photo-1559314809-0d155014e29e?w=400&h=300&fit=crop",
                calories: 495,
                protein: 36,
                carbs: 58,
                fat: 16,
                servings: 4,
                tags: ["thai", "noodles", "stir fry"],
                source: "TikTok @thaifood",
                url: "https://www.tiktok.com/@thaifood/video/padthai",
                ingredients: [
                    { name: "Chicken Breast", amount: 160, unit: "g", perServing: true },
                    { name: "Rice Noodles", amount: 80, unit: "g", perServing: true },
                    { name: "Eggs", amount: 1, unit: "pc", perServing: true },
                    { name: "Bean Sprouts", amount: 40, unit: "g", perServing: true },
                    { name: "Green Onions", amount: 20, unit: "g", perServing: true },
                    { name: "Garlic", amount: 8, unit: "g", perServing: true },
                    { name: "Tamarind Paste", amount: 15, unit: "g", perServing: true },
                    { name: "Fish Sauce", amount: 15, unit: "ml", perServing: true },
                    { name: "Palm Sugar", amount: 15, unit: "g", perServing: true },
                    { name: "Lime", amount: 0.5, unit: "pc", perServing: true },
                    { name: "Peanuts", amount: 15, unit: "g", perServing: true }
                ],
                directions: [
                    "Soak rice noodles in warm water until softened, drain",
                    "Mix tamarind, fish sauce, and palm sugar for sauce",
                    "Stir-fry garlic and chicken until cooked through",
                    "Push chicken aside, scramble egg in the pan",
                    "Add noodles and sauce, toss everything together",
                    "Add bean sprouts and green onions, cook for 1 minute",
                    "Serve with lime wedge and crushed peanuts on top"
                ]
            },
            {
                id: 10,
                name: "ü•© High Protein Pepper Steak Rice Bowls",
                image: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=300&fit=crop",
                calories: 520,
                protein: 53,
                carbs: 45,
                fat: 18,
                servings: 4,
                tags: ["high protein", "meal prep", "video"],
                source: "TikTok @panaceapalm",
                url: "https://www.tiktok.com/@panaceapalm",
                ingredients: [
                    { name: "Lean Steak", amount: 200, unit: "g", perServing: true },
                    { name: "Bell Peppers", amount: 100, unit: "g", perServing: true },
                    { name: "Onion", amount: 50, unit: "g", perServing: true },
                    { name: "Rice", amount: 150, unit: "g", perServing: true },
                    { name: "Soy Sauce", amount: 15, unit: "ml", perServing: true }
                ],
                directions: ["Watch video for full instructions! Slice steak and stir-fry with peppers and onions. Serve over rice with soy sauce."]
            },
            {
                id: 11,
                name: "üçú Sweet Chilli Chicken Noodle Salad",
                image: "https://images.unsplash.com/photo-1547592166-23acbe346499?w=400&h=300&fit=crop",
                calories: 420,
                protein: 28,
                carbs: 55,
                fat: 12,
                servings: 4,
                tags: ["cold", "meal prep", "video"],
                source: "TikTok @zoeeatswell",
                url: "https://www.tiktok.com/@zoeeatswell",
                ingredients: [
                    { name: "Rice Noodles", amount: 80, unit: "g", perServing: true },
                    { name: "Chicken Breast", amount: 150, unit: "g", perServing: true },
                    { name: "Cucumber", amount: 50, unit: "g", perServing: true },
                    { name: "Carrot", amount: 40, unit: "g", perServing: true },
                    { name: "Sweet Chilli Sauce", amount: 20, unit: "g", perServing: true },
                    { name: "Coriander", amount: 5, unit: "g", perServing: true },
                    { name: "Peanuts", amount: 10, unit: "g", perServing: true }
                ],
                directions: ["Cook noodles and chicken. Mix with vegetables and sauce. Top with coriander and peanuts."]
            },
            {
                id: 12,
                name: "üçó Sweet Chilli Popcorn Chicken",
                image: "https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?w=400&h=300&fit=crop",
                calories: 496,
                protein: 35,
                carbs: 42,
                fat: 22,
                servings: 4,
                tags: ["high protein", "crispy", "video"],
                source: "TikTok @panaceapalm",
                url: "https://www.tiktok.com/@panaceapalm",
                ingredients: [
                    { name: "Chicken Breast", amount: 200, unit: "g", perServing: true },
                    { name: "Sweet Chilli Sauce", amount: 30, unit: "g", perServing: true },
                    { name: "Sesame Seeds", amount: 5, unit: "g", perServing: true },
                    { name: "Flour", amount: 30, unit: "g", perServing: true }
                ],
                directions: ["Coat chicken pieces and fry until crispy. Toss in sweet chilli sauce. Sprinkle with sesame seeds."]
            },
            {
                id: 13,
                name: "üçï Cottage Cheese Pizza Toast",
                image: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400&h=300&fit=crop",
                calories: 486,
                protein: 33,
                carbs: 38,
                fat: 24,
                servings: 2,
                tags: ["quick", "high protein", "video"],
                source: "TikTok",
                url: "https://www.tiktok.com",
                ingredients: [
                    { name: "Bread", amount: 2, unit: "slice", perServing: true },
                    { name: "Cottage Cheese", amount: 80, unit: "g", perServing: true },
                    { name: "Pizza Sauce", amount: 30, unit: "g", perServing: true },
                    { name: "Hot Honey", amount: 10, unit: "g", perServing: true },
                    { name: "Mixed Herbs", amount: 2, unit: "g", perServing: true }
                ],
                directions: ["Toast bread, spread with cottage cheese and pizza sauce. Drizzle with hot honey and sprinkle herbs."]
            },
            {
                id: 3,
                name: "üçö Oyakodon (Chicken & Egg Rice Bowl)",
                image: "https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?w=400&h=300&fit=crop",
                calories: 485,
                protein: 38,
                carbs: 52,
                fat: 14,
                servings: 4,
                tags: ["japanese", "comfort food", "rice bowl", "video"],
                source: "TikTok @japanesefoodie",
                url: "https://www.tiktok.com/@japanesefoodie/video/oyakodon",
                ingredients: [
                    { name: "Chicken Thighs", amount: 200, unit: "g", perServing: true },
                    { name: "Eggs", amount: 2, unit: "pc", perServing: true },
                    { name: "Onion", amount: 80, unit: "g", perServing: true },
                    { name: "Dashi Stock", amount: 60, unit: "ml", perServing: true },
                    { name: "Soy Sauce", amount: 15, unit: "ml", perServing: true },
                    { name: "Mirin", amount: 15, unit: "ml", perServing: true },
                    { name: "Sugar", amount: 5, unit: "g", perServing: true },
                    { name: "Cooked Rice", amount: 200, unit: "g", perServing: true },
                    { name: "Green Onions", amount: 10, unit: "g", perServing: true }
                ],
                directions: [
                    "Slice chicken and onion into bite-sized pieces",
                    "In a pan, combine dashi, soy sauce, mirin, and sugar. Bring to a simmer",
                    "Add onions and cook for 2-3 minutes until softened",
                    "Add chicken and cook until no longer pink",
                    "Pour beaten eggs evenly over the chicken, cover and cook for 1-2 minutes",
                    "Slide the finished oyakodon over a bowl of rice, garnish with green onions"
                ]
            },
            {
                id: 14,
                name: "ü•î Potato & Chicken Bake",
                image: "https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=400&h=300&fit=crop",
                calories: 580,
                protein: 38,
                carbs: 52,
                fat: 26,
                servings: 5,
                tags: ["comfort food", "meal prep", "video"],
                source: "TikTok @elliewilsonfitness",
                url: "https://www.tiktok.com/@elliewilsonfitness",
                ingredients: [
                    { name: "Potatoes", amount: 250, unit: "g", perServing: true },
                    { name: "Chicken Breast", amount: 180, unit: "g", perServing: true },
                    { name: "Bacon", amount: 40, unit: "g", perServing: true },
                    { name: "Cheese", amount: 50, unit: "g", perServing: true },
                    { name: "Cream", amount: 30, unit: "ml", perServing: true },
                    { name: "Spring Onions", amount: 10, unit: "g", perServing: true }
                ],
                directions: ["Layer potatoes, chicken, and bacon in a dish. Pour over cream and top with cheese. Bake until golden."]
            },
            {
                id: 15,
                name: "üåÆ Chicken Katsu Smashed Tacos",
                image: "https://images.unsplash.com/photo-1529042410759-befb1204b468?w=400&h=300&fit=crop",
                calories: 520,
                protein: 32,
                carbs: 48,
                fat: 22,
                servings: 4,
                tags: ["crispy", "fusion", "video"],
                source: "TikTok @tomjustcooks",
                url: "https://www.tiktok.com/@tomjustcooks",
                ingredients: [
                    { name: "Chicken Breast", amount: 180, unit: "g", perServing: true },
                    { name: "Tortillas", amount: 2, unit: "pc", perServing: true },
                    { name: "Cabbage", amount: 50, unit: "g", perServing: true },
                    { name: "Green Onions", amount: 10, unit: "g", perServing: true },
                    { name: "Sesame Seeds", amount: 5, unit: "g", perServing: true },
                    { name: "Katsu Sauce", amount: 20, unit: "g", perServing: true }
                ],
                directions: ["Bread and fry chicken katsu. Smash tortillas in pan. Top with sliced chicken, cabbage, green onions and sauce."]
            },
            {
                id: 16,
                name: "üç´ Mars Bar Protein Crisp Slice",
                image: "https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=300&fit=crop",
                calories: 200,
                protein: 8,
                carbs: 22,
                fat: 10,
                servings: 12,
                tags: ["dessert", "snack", "video"],
                source: "TikTok @mazzfitt",
                url: "https://www.tiktok.com/@mazzfitt",
                ingredients: [
                    { name: "Rice Krispies", amount: 40, unit: "g", perServing: true },
                    { name: "Protein Powder", amount: 15, unit: "g", perServing: true },
                    { name: "Chocolate", amount: 20, unit: "g", perServing: true },
                    { name: "Honey", amount: 10, unit: "g", perServing: true },
                    { name: "Peanut Butter", amount: 10, unit: "g", perServing: true }
                ],
                directions: ["Mix rice krispies with protein and peanut butter. Press into pan. Melt chocolate and pour over. Chill and slice."]
            },
            {
                id: 9,
                name: "üç† Sweet Potato Bowls",
                image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400&h=300&fit=crop",
                calories: 485,
                protein: 18,
                carbs: 68,
                fat: 16,
                servings: 6,
                tags: ["vegetarian", "meal prep", "healthy"],
                source: "TikTok @healthyrecipes",
                url: "https://www.tiktok.com/@healthyrecipes/video/sweetpotato",
                ingredients: [
                    { name: "Sweet Potatoes", amount: 200, unit: "g", perServing: true },
                    { name: "Corn", amount: 80, unit: "g", perServing: true },
                    { name: "Black Beans", amount: 60, unit: "g", perServing: true },
                    { name: "Red Onion", amount: 30, unit: "g", perServing: true },
                    { name: "Cilantro", amount: 10, unit: "g", perServing: true },
                    { name: "Avocado", amount: 0.5, unit: "pc", perServing: true },
                    { name: "Lime", amount: 0.5, unit: "pc", perServing: true },
                    { name: "Greek Yogurt", amount: 30, unit: "g", perServing: true },
                    { name: "Chili Powder", amount: 2, unit: "g", perServing: true },
                    { name: "Cumin", amount: 1, unit: "g", perServing: true }
                ],
                directions: [
                    "Preheat oven to 220C / 425F",
                    "Cube sweet potatoes, toss with olive oil, chili powder, cumin, salt and pepper",
                    "Roast for 25-30 minutes until tender and slightly crispy",
                    "Mix corn and black beans together",
                    "Make lime crema by mixing Greek yogurt with lime juice and salt",
                    "Assemble bowls with sweet potatoes, corn & beans, red onion, and avocado",
                    "Top with cilantro and drizzle with lime crema"
                ]
            }
        ];

        // Ingredient Aliases - Maps variations to standard names
        const ingredientAliases = {
            'chicken thighs (boneless, skinless)': 'Chicken Thighs',
            'boneless skinless chicken thighs': 'Chicken Thighs',
            'boneless chicken thighs': 'Chicken Thighs',
            'chicken thighs': 'Chicken Thighs',
            'chicken thigh': 'Chicken Thighs',
            'chicken breast': 'Chicken Breast',
            'chicken breasts': 'Chicken Breast',
            'bell peppers': 'Bell Peppers',
            'bell pepper': 'Bell Peppers',
            'capsicum': 'Bell Peppers',
            'red bell pepper': 'Bell Peppers',
            'green bell pepper': 'Bell Peppers',
            'yellow bell pepper': 'Bell Peppers',
            'red onion': 'Red Onion',
            'red onions': 'Red Onion',
            'white onion': 'White Onion',
            'white onions': 'White Onion',
            'onion': 'Onion',
            'onions': 'Onion',
            'garlic': 'Garlic',
            'garlic cloves': 'Garlic',
            'minced garlic': 'Garlic',
            'sesame seeds': 'Sesame Seeds',
            'honey': 'Honey',
            'yogurt': 'Yogurt',
            'low fat yogurt': 'Yogurt',
            'greek yogurt': 'Yogurt',
            'mayo': 'Mayonnaise',
            'mayonnaise': 'Mayonnaise',
            'light mayo': 'Mayonnaise',
            'soy sauce': 'Soy Sauce',
            'light soy sauce': 'Soy Sauce',
            'dark soy sauce': 'Soy Sauce',
            'cucumber': 'Cucumber',
            'cucumbers': 'Cucumber',
            'carrots': 'Carrots',
            'grated carrots': 'Carrots',
            'carrot': 'Carrots',
            'rice vinegar': 'Rice Vinegar',
            'sriracha': 'Sriracha',
            'wraps': 'Wraps',
            'tortilla wraps': 'Wraps',
            'low carb wraps': 'Wraps',
            'flour wraps': 'Wraps',
            'tortillas': 'Tortillas',
            'corn tortillas': 'Tortillas',
            'cheese': 'Cheese',
            'cheddar cheese': 'Cheddar Cheese',
            'mozzarella cheese': 'Mozzarella',
            'feta cheese': 'Feta Cheese',
            'parmesan cheese': 'Parmesan',
            'olive oil': 'Olive Oil',
            'butter': 'Butter',
            'salt': 'Salt',
            'pepper': 'Black Pepper',
            'black pepper': 'Black Pepper'
        };

        function normalizeIngredientName(name) {
            const lowerName = name.toLowerCase().trim();
            // Check for exact match first
            if (ingredientAliases[lowerName]) {
                return ingredientAliases[lowerName];
            }
            // Check if any alias is contained in the name
            for (const [alias, standard] of Object.entries(ingredientAliases)) {
                if (lowerName.includes(alias)) {
                    return standard;
                }
            }
            // Return original with proper capitalization
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        // State
        let currentWeekOffset = 0;
        let mealPlan = {}; // { "2024-01-15-lunch": recipeId, ... }
        let servingsCount = 1; // Number of people to cook for
        let favoriteRecipes = new Set(); // Set of favorite recipe IDs
        let showFavoritesOnly = false; // Filter toggle
        let customGroceryItems = []; // Custom items added by user
        
        // API Base URL - change this to your server URL
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3002' 
            : 'https://jacquline-cactoid-vanetta.ngrok-free.dev';

        // Confetti effect for completing week
        function celebrateWeekComplete() {
            const totalSlots = 28; // 7 days √ó 4 meals
            const filledSlots = Object.keys(mealPlan).length;
            
            if (filledSlots === totalSlots) {
                // Create confetti
                for (let i = 0; i < 50; i++) {
                    createConfetti();
                }
            }
        }

        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            const confetti = document.createElement('div');
            confetti.style.position = 'fixed';
            confetti.style.width = '10px';
            confetti.style.height = '10px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.top = '-10px';
            confetti.style.borderRadius = '50%';
            confetti.style.zIndex = '9999';
            confetti.style.pointerEvents = 'none';
            document.body.appendChild(confetti);
            
            const animation = confetti.animate([
                { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 2000,
                easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
            });
            
            animation.onfinish = () => confetti.remove();
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--ios-green)' : 'var(--ios-blue)'};
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                font-weight: 600;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Toggle favorite
        function toggleFavorite(recipeId, event) {
            event.stopPropagation();
            if (favoriteRecipes.has(recipeId)) {
                favoriteRecipes.delete(recipeId);
                showToast('Removed from favorites');
            } else {
                favoriteRecipes.add(recipeId);
                showToast('Added to favorites! ‚≠ê');
            }
            saveFavorites();
            renderRecipes(document.getElementById('searchInput').value);
        }

        // Save favorites
        function saveFavorites() {
            localStorage.setItem('favoriteRecipes', JSON.stringify([...favoriteRecipes]));
        }

        // Load favorites
        function loadFavorites() {
            const saved = localStorage.getItem('favoriteRecipes');
            if (saved) {
                favoriteRecipes = new Set(JSON.parse(saved));
            }
        }

        // Toggle favorites filter
        function toggleFavoritesFilter() {
            showFavoritesOnly = !showFavoritesOnly;
            const btn = document.getElementById('favoritesFilterBtn');
            if (btn) {
                btn.style.background = showFavoritesOnly ? 'var(--ios-yellow)' : '';
                btn.textContent = showFavoritesOnly ? '‚≠ê Favorites Only' : '‚òÜ Show Favorites';
            }
            renderRecipes(document.getElementById('searchInput').value);
        }

        // Load saved data from localStorage
        // Load data from server
        async function loadSavedData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/data/mealplan`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    if (data.mealPlan) {
                        mealPlan = data.mealPlan;
                        console.log('Loaded meal plan from server:', Object.keys(mealPlan).length, 'meals');
                    }
                    if (data.currentWeekOffset !== undefined) {
                        currentWeekOffset = data.currentWeekOffset;
                    }
                    if (data.servingsCount !== undefined) {
                        servingsCount = data.servingsCount;
                        document.getElementById('servingsInput').value = servingsCount;
                    }
                    if (data.favoriteRecipes) {
                        favoriteRecipes = new Set(data.favoriteRecipes);
                    }
                    if (data.customGroceryItems) {
                        customGroceryItems = data.customGroceryItems;
                        customGroceryItems.forEach(item => {
                            if (!commonGroceryItems.find(i => i.id === item.id)) {
                                commonGroceryItems.push(item);
                            }
                        });
                    }
                    
                    showToast('üì• Loaded shared meal plan');
                }
            } catch (e) {
                console.error('Error loading saved data from server:', e);
                showToast('‚ö†Ô∏è Using default data', 'warning');
            }
        }

        // Save data to server
        async function saveData() {
            try {
                const data = {
                    mealPlan: mealPlan,
                    currentWeekOffset: currentWeekOffset,
                    servingsCount: servingsCount,
                    favoriteRecipes: [...favoriteRecipes],
                    customGroceryItems: customGroceryItems
                };
                
                const response = await fetch(`${API_BASE_URL}/api/data/mealplan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('üíæ Saved to server:', result.lastUpdated);
                    // Check if week is complete
                    celebrateWeekComplete();
                } else {
                    console.error('Failed to save:', result.error);
                }
            } catch (e) {
                console.error('Error saving data to server:', e);
            }
        }

        // Save favorites to server
        async function saveFavorites() {
            await saveData();
        }

        // Load favorites (now handled in loadSavedData)
        function loadFavorites() {
            // Favorites are loaded in loadSavedData
        }

        // Initialize
        async function init() {
            // Load saved meal plan data first
            await loadSavedData();
            
            // First check for downloaded videos and update recipe data
            try {
                await loadVideoData();
            } catch (e) {
                console.error('Error loading video data:', e);
            }
            
            // Always render recipes even if video loading fails
            renderRecipes();
            renderCalendar();
            updateMacroSummary();
            renderMobileDaySwiper();
            
            document.getElementById('searchInput').addEventListener('input', filterRecipes);
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeMobilePanel();
                }
            });
            
            // Touch swipe detection for mobile calendar
            initTouchGestures();
        }
        
        // Load video data for all recipes on startup
        async function loadVideoData() {
            try {
                // Add timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${API_BASE_URL}/api/videos/list`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success && data.videos) {
                    // For each video, update the corresponding recipe
                    for (const video of data.videos) {
                        if (video.recipeId) {
                            const recipe = recipes.find(r => r.id === video.recipeId);
                            if (recipe) {
                                recipe.localVideo = video.path;
                                
                                // Also fetch thumbnail
                                try {
                                    const thumbResponse = await fetch(`${API_BASE_URL}/api/videos/thumbnail?recipeId=${video.recipeId}`);
                                    const thumbData = await thumbResponse.json();
                                    if (thumbData.success && thumbData.thumbnailPath) {
                                        recipe.localThumbnail = thumbData.thumbnailPath;
                                    }
                                } catch (thumbError) {
                                    console.log('No thumbnail for recipe', video.recipeId);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading video data:', error);
                // Don't throw - let the app continue without videos
            }
        }
        
        // Mobile Day Swiper
        let currentMobileDay = 0;
        
        function renderMobileDaySwiper() {
            const swiper = document.getElementById('daySwiper');
            if (!swiper) return;
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            
            swiper.innerHTML = days.map((dayName, index) => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + index);
                const isToday = date.toDateString() === today.toDateString();
                const isActive = index === currentMobileDay;
                
                return `
                    <div class="day-swiper-item ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}" 
                         onclick="selectMobileDay(${index})" data-index="${index}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${date.getDate()}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll active day into view
            const activeItem = swiper.querySelector('.day-swiper-item.active');
            if (activeItem) {
                activeItem.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }
        
        function selectMobileDay(index) {
            currentMobileDay = index;
            renderMobileDaySwiper();
            
            // Scroll to the selected day in the calendar
            const dayColumns = document.querySelectorAll('.day-column');
            if (dayColumns[index]) {
                dayColumns[index].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Mobile View Switching
        function switchMobileView(view) {
            // Update nav active state
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${view}`).classList.add('active');
            
            if (view === 'recipes') {
                // Open recipe panel
                document.getElementById('recipePanel').classList.add('mobile-open');
                document.getElementById('mobilePanelOverlay').classList.add('active');
                switchTab('recipes');
            } else if (view === 'groceries') {
                // Open grocery panel
                document.getElementById('recipePanel').classList.add('mobile-open');
                document.getElementById('mobilePanelOverlay').classList.add('active');
                switchTab('groceries');
            } else if (view === 'calendar') {
                // Close any open panels
                closeMobilePanel();
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function closeMobilePanel() {
            document.getElementById('recipePanel').classList.remove('mobile-open');
            document.getElementById('mobilePanelOverlay').classList.remove('active');
            
            // Reset nav to calendar if we were on recipes/groceries
            const activeNav = document.querySelector('.mobile-nav-item.active');
            if (activeNav && (activeNav.id === 'nav-recipes' || activeNav.id === 'nav-groceries')) {
                document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
                document.getElementById('nav-calendar').classList.add('active');
            }
        }
        
        // Touch Gestures for Mobile
        function initTouchGestures() {
            let touchStartX = 0;
            let touchEndX = 0;
            
            const calendarContainer = document.querySelector('.calendar-container');
            if (!calendarContainer) return;
            
            calendarContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            calendarContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swipe left - next week
                        changeWeek(1);
                    } else {
                        // Swipe right - previous week
                        changeWeek(-1);
                    }
                }
            }
        }
        
        // Override changeWeek to also update mobile swiper
        const originalChangeWeek = changeWeek;
        changeWeek = function(direction) {
            currentWeekOffset += direction;
            renderCalendar();
            renderMobileDaySwiper();
            updateMacroSummary();
        };

        // Render Recipe Cards
        function renderRecipes(filter = '') {
            const list = document.getElementById('recipeList');
            let filtered = recipes.filter(r => 
                r.name.toLowerCase().includes(filter.toLowerCase()) ||
                r.tags.some(t => t.toLowerCase().includes(filter.toLowerCase()))
            );
            
            // Filter by favorites if enabled
            if (showFavoritesOnly) {
                filtered = filtered.filter(r => favoriteRecipes.has(r.id));
            }
            
            list.innerHTML = filtered.map(recipe => {
                // Use local video thumbnail if available, otherwise use the recipe image
                const thumbnailSrc = recipe.localThumbnail || recipe.image;
                const hasVideo = !!recipe.localVideo;
                const isFavorite = favoriteRecipes.has(recipe.id);
                
                return `
                <div class="recipe-card ${isFavorite ? 'favorite' : ''}" draggable="true" data-recipe-id="${recipe.id}" onclick="openRecipeModal(${recipe.id})">
                    ${thumbnailSrc ? `
                        <div style="position: relative;">
                            <img src="${thumbnailSrc}" alt="${recipe.name}" class="recipe-thumbnail" loading="lazy">
                            ${hasVideo ? `
                                <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                                    ‚ñ∂Ô∏è Video
                                </div>
                            ` : ''}
                            <button class="favorite-btn ${isFavorite ? 'active' : ''}" 
                                    onclick="toggleFavorite(${recipe.id}, event)"
                                    style="position: absolute; top: 8px; right: 8px; background: ${isFavorite ? '#FFD700' : 'rgba(255,255,255,0.9)'}; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s ease;"
                                    title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                                ${isFavorite ? '‚≠ê' : '‚òÜ'}
                            </button>
                        </div>
                    ` : ''}
                    <h3>${recipe.name}</h3>
                    <div class="recipe-meta">
                        <span>üî• ${recipe.calories} cal</span>
                        <span>üí™ ${recipe.protein}g pro</span>
                    </div>
                    <div class="recipe-tags">
                        ${recipe.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>
                </div>
            `}).join('');
            
            // Add drag listeners
            document.querySelectorAll('.recipe-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        function filterRecipes(e) {
            renderRecipes(e.target.value);
        }

        // Drag & Drop Handlers
        let draggedRecipe = null;
        let draggedElement = null;

        function handleDragStart(e) {
            draggedRecipe = recipes.find(r => r.id == this.dataset.recipeId);
            draggedElement = this;
            this.classList.add('dragging');
            
            // Set drag image for smoother experience
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', this.dataset.recipeId);
            
            // Add visual feedback after a slight delay
            setTimeout(() => {
                this.style.opacity = '0.6';
            }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';
            draggedRecipe = null;
            draggedElement = null;
            
            // Clean up any drag-over states
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            
            // Add drag-over class with throttling
            if (!this.classList.contains('drag-over')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.stopPropagation();
            // Only remove if we're actually leaving the element (not entering a child)
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            if (!draggedRecipe) return;
            
            const slotKey = this.dataset.slot;
            
            // Check if moving from another slot
            if (draggedElement && draggedElement.dataset.slot) {
                const sourceSlot = draggedElement.dataset.slot;
                delete mealPlan[sourceSlot];
                saveData(); // Persist to localStorage
            }
            
            mealPlan[slotKey] = draggedRecipe;
            saveData(); // Persist to localStorage
            
            // Animate the change
            requestAnimationFrame(() => {
                renderCalendar();
                updateMacroSummary();
            });
        }

        function handleMealDragStart(e) {
            const slotKey = this.dataset.slot;
            draggedRecipe = mealPlan[slotKey];
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', 'move');
            
            setTimeout(() => {
                this.style.opacity = '0.5';
            }, 0);
        }

        function handleMealDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';
            draggedRecipe = null;
            draggedElement = null;
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        // Render Calendar
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            
            document.getElementById('weekDisplay').textContent = 
                currentWeekOffset === 0 ? 'This Week' : 
                currentWeekOffset === 1 ? 'Next Week' : 
                `Week ${currentWeekOffset > 0 ? '+' + currentWeekOffset : currentWeekOffset}`;
            
            grid.innerHTML = days.map((dayName, index) => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + index);
                const dateKey = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                
                const breakfast = mealPlan[`${dateKey}-breakfast`];
                const lunch = mealPlan[`${dateKey}-lunch`];
                const dinner = mealPlan[`${dateKey}-dinner`];
                const snacks = mealPlan[`${dateKey}-snacks`];
                
                // Calculate daily macros (multiplied by servings)
                const dailyCalories = ((breakfast?.calories || 0) + (lunch?.calories || 0) + (dinner?.calories || 0) + (snacks?.calories || 0)) * servingsCount;
                const dailyProtein = ((breakfast?.protein || 0) + (lunch?.protein || 0) + (dinner?.protein || 0) + (snacks?.protein || 0)) * servingsCount;
                const dailyCarbs = ((breakfast?.carbs || 0) + (lunch?.carbs || 0) + (dinner?.carbs || 0) + (snacks?.carbs || 0)) * servingsCount;
                const dailyFat = ((breakfast?.fat || 0) + (lunch?.fat || 0) + (dinner?.fat || 0) + (snacks?.fat || 0)) * servingsCount;
                const hasMeals = breakfast || lunch || dinner || snacks;
                
                return `
                    <div class="day-column">
                        <div class="day-header ${isToday ? 'today' : ''}">
                            <div class="day-name">${dayName}</div>
                            <div class="day-number">${date.getDate()}</div>
                        </div>
                        <div class="meal-slots">
                            <div class="meal-slot">
                                <div class="meal-label">üåÖ Breakfast</div>
                                <div class="drop-zone" data-slot="${dateKey}-breakfast" 
                                     ondragover="handleDragOver.call(this, event)" 
                                     ondragleave="handleDragLeave.call(this, event)"
                                     ondrop="handleDrop.call(this, event)">
                                    ${breakfast ? `
                                        <div class="meal-item" draggable="true" data-slot="${dateKey}-breakfast" data-recipe-id="${breakfast.id}"
                                             ondragstart="handleMealDragStart.call(this, event)"
                                             ondragend="handleMealDragEnd.call(this, event)"
                                             onclick="openRecipeModal(${breakfast.id})">
                                            <span>${breakfast.name}</span>
                                            <button class="remove" onclick="event.stopPropagation(); removeMeal('${dateKey}-breakfast', event)">√ó</button>
                                        </div>
                                    ` : '<div class="placeholder">Drop here</div>'}
                                </div>
                            </div>
                            <div class="meal-slot">
                                <div class="meal-label">üåû Lunch</div>
                                <div class="drop-zone" data-slot="${dateKey}-lunch" 
                                     ondragover="handleDragOver.call(this, event)" 
                                     ondragleave="handleDragLeave.call(this, event)"
                                     ondrop="handleDrop.call(this, event)">
                                    ${lunch ? `
                                        <div class="meal-item" draggable="true" data-slot="${dateKey}-lunch" data-recipe-id="${lunch.id}"
                                             ondragstart="handleMealDragStart.call(this, event)"
                                             ondragend="handleMealDragEnd.call(this, event)"
                                             onclick="openRecipeModal(${lunch.id})">
                                            <span>${lunch.name}</span>
                                            <button class="remove" onclick="event.stopPropagation(); removeMeal('${dateKey}-lunch', event)">√ó</button>
                                        </div>
                                    ` : '<div class="placeholder">Drop here</div>'}
                                </div>
                            </div>
                            <div class="meal-slot">
                                <div class="meal-label">üåô Dinner</div>
                                <div class="drop-zone" data-slot="${dateKey}-dinner"
                                     ondragover="handleDragOver.call(this, event)" 
                                     ondragleave="handleDragLeave.call(this, event)"
                                     ondrop="handleDrop.call(this, event)">
                                    ${dinner ? `
                                        <div class="meal-item" draggable="true" data-slot="${dateKey}-dinner" data-recipe-id="${dinner.id}"
                                             ondragstart="handleMealDragStart.call(this, event)"
                                             ondragend="handleMealDragEnd.call(this, event)"
                                             onclick="openRecipeModal(${dinner.id})">
                                            <span>${dinner.name}</span>
                                            <button class="remove" onclick="event.stopPropagation(); removeMeal('${dateKey}-dinner', event)">√ó</button>
                                        </div>
                                    ` : '<div class="placeholder">Drop here</div>'}
                                </div>
                            </div>
                            <div class="meal-slot">
                                <div class="meal-label">üçø Snacks</div>
                                <div class="drop-zone" data-slot="${dateKey}-snacks"
                                     ondragover="handleDragOver.call(this, event)" 
                                     ondragleave="handleDragLeave.call(this, event)"
                                     ondrop="handleDrop.call(this, event)">
                                    ${snacks ? `
                                        <div class="meal-item" draggable="true" data-slot="${dateKey}-snacks" data-recipe-id="${snacks.id}"
                                             ondragstart="handleMealDragStart.call(this, event)"
                                             ondragend="handleMealDragEnd.call(this, event)"
                                             onclick="openRecipeModal(${snacks.id})">
                                            <span>${snacks.name}</span>
                                            <button class="remove" onclick="event.stopPropagation(); removeMeal('${dateKey}-snacks', event)">√ó</button>
                                        </div>
                                    ` : '<div class="placeholder">Drop here</div>'}
                                </div>
                            </div>
                        </div>
                        ${hasMeals ? `
                            <div class="daily-macros">
                                <div class="daily-macro-item">
                                    <div class="daily-macro-value">${dailyCalories}</div>
                                    <div>cal</div>
                                </div>
                                <div class="daily-macro-item">
                                    <div class="daily-macro-value">${dailyProtein}g</div>
                                    <div>pro</div>
                                </div>
                                <div class="daily-macro-item">
                                    <div class="daily-macro-value">${dailyCarbs}g</div>
                                    <div>carb</div>
                                </div>
                                <div class="daily-macro-item">
                                    <div class="daily-macro-value">${dailyFat}g</div>
                                    <div>fat</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function removeMeal(slotKey, event) {
            if (event) {
                event.stopPropagation();
            }
            delete mealPlan[slotKey];
            saveData(); // Persist to localStorage
            renderCalendar();
            updateMacroSummary();
        }

        // Track current recipe for video operations
        let currentRecipeId = null;
        let currentRecipe = null;

        // Recipe Modal Functions
        async function openRecipeModal(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            currentRecipeId = recipeId;
            currentRecipe = recipe;
            
            document.getElementById('modalTitle').textContent = recipe.name;
            document.getElementById('modalSource').textContent = `Source: ${recipe.source || 'Unknown'}`;
            
            // Update image
            const modalImage = document.getElementById('modalImage');
            if (recipe.image) {
                modalImage.src = recipe.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            // Check for downloaded video
            await checkForVideo(recipeId);
            
            // Update link and video download section
            const linkSection = document.getElementById('modalLinkSection');
            const linkElement = document.getElementById('modalLink');
            const videoDownloadSection = document.getElementById('videoDownloadSection');
            
            if (recipe.url) {
                linkSection.style.display = 'block';
                linkElement.href = recipe.url;
                linkElement.textContent = `View on ${recipe.source || 'Source'} ‚Üí`;
                videoDownloadSection.style.display = 'block';
            } else {
                linkSection.style.display = 'none';
            }
            
            // Update macros
            const macrosHtml = `
                <div class="modal-macro-item">
                    <div class="modal-macro-value">${recipe.calories}</div>
                    <div class="modal-macro-label">calories</div>
                </div>
                <div class="modal-macro-item">
                    <div class="modal-macro-value">${recipe.protein}g</div>
                    <div class="modal-macro-label">protein</div>
                </div>
                <div class="modal-macro-item">
                    <div class="modal-macro-value">${recipe.carbs}g</div>
                    <div class="modal-macro-label">carbs</div>
                </div>
                <div class="modal-macro-item">
                    <div class="modal-macro-value">${recipe.fat}g</div>
                    <div class="modal-macro-label">fat</div>
                </div>
            `;
            document.getElementById('modalMacros').innerHTML = macrosHtml;
            
            // Update ingredients
            const ingredientsHtml = recipe.ingredients.map(ing => `
                <li>
                    <span>${ing.name}</span>
                    <span><strong>${ing.amount}${ing.unit}</strong></span>
                </li>
            `).join('');
            document.getElementById('modalIngredients').innerHTML = ingredientsHtml;
            
            // Update directions
            const directionsHtml = recipe.directions.map((step, i) => `
                <li>${step}</li>
            `).join('');
            document.getElementById('modalDirections').innerHTML = directionsHtml;
            
            // Show modal
            document.getElementById('recipeModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('recipeModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.getElementById('recipeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Video Download Functions
        async function checkForVideo(recipeId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/videos/list`);
                const data = await response.json();
                
                if (data.success && data.videos) {
                    // Find video for this recipe
                    const video = data.videos.find(v => v.recipeId === recipeId);
                    
                    const videoSection = document.getElementById('modalVideoSection');
                    const videoElement = document.getElementById('modalVideo');
                    const modalImage = document.getElementById('modalImage');
                    const downloadStatus = document.getElementById('videoDownloadStatus');
                    
                    if (video) {
                        // Video exists - show it
                        videoElement.src = video.path;
                        videoElement.muted = true; // Mute for autoplay
                        videoSection.style.display = 'block';
                        modalImage.style.display = 'none'; // Hide image when video is available
                        
                        // Try to find thumbnail for this video
                        const thumbResponse = await fetch(`${API_BASE_URL}/api/videos/thumbnail?recipeId=${recipeId}`);
                        const thumbData = await thumbResponse.json();
                        
                        if (thumbData.success && thumbData.thumbnailPath) {
                            // Use video thumbnail as poster and update recipe card
                            videoElement.poster = thumbData.thumbnailPath;
                            
                            // Update the recipe object with local thumbnail
                            const recipe = recipes.find(r => r.id === recipeId);
                            if (recipe) {
                                recipe.localThumbnail = thumbData.thumbnailPath;
                                recipe.localVideo = video.path;
                                // Re-render recipes to show new thumbnail
                                renderRecipes();
                            }
                        } else {
                            videoElement.poster = modalImage.src;
                        }
                        
                        // Auto-play the video (muted to comply with browser policies)
                        videoElement.play().catch(err => {
                            console.log('Autoplay blocked:', err);
                        });
                        
                        // Update download button to delete option
                        downloadStatus.innerHTML = `
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="toggleVideoMute()" id="muteBtn" style="flex: 1;">
                                    üîá Unmute
                                </button>
                                <button class="btn btn-secondary" onclick="deleteRecipeVideo('${video.filename}')" style="flex: 1; background: #ff4444; color: white;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--ios-green); margin-top: 8px; text-align: center;">
                                ‚úÖ Video saved locally
                            </p>
                        `;
                    } else {
                        // No video - hide video section, show image
                        videoSection.style.display = 'none';
                        videoElement.src = '';
                        if (modalImage.src) modalImage.style.display = 'block';
                        
                        // Show download button
                        downloadStatus.innerHTML = `
                            <button class="btn btn-secondary" onclick="downloadRecipeVideo()" style="width: 100%;">
                                üì• Download Video
                            </button>
                            <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px; text-align: center;">
                                Save locally so you never lose this recipe
                            </p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking for video:', error);
            }
        }

        function playVideo() {
            const video = document.getElementById('modalVideo');
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function toggleVideoMute() {
            const video = document.getElementById('modalVideo');
            const muteBtn = document.getElementById('muteBtn');
            
            if (video.muted) {
                video.muted = false;
                if (muteBtn) muteBtn.innerHTML = 'üîä Mute';
            } else {
                video.muted = true;
                if (muteBtn) muteBtn.innerHTML = 'üîá Unmute';
            }
        }

        async function downloadRecipeVideo() {
            if (!currentRecipe || !currentRecipe.url) {
                alert('No video URL available for this recipe');
                return;
            }
            
            const downloadStatus = document.getElementById('videoDownloadStatus');
            downloadStatus.innerHTML = `
                <div class="video-download-progress spinner">
                    ‚è≥ Downloading video... This may take a minute
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/videos/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: currentRecipe.url,
                        recipeId: currentRecipeId,
                        recipeName: currentRecipe.name.replace(/^[^\w\s]+\s*/, '') // Remove emoji
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Video downloaded - refresh the modal to show it
                    await checkForVideo(currentRecipeId);
                } else {
                    downloadStatus.innerHTML = `
                        <button class="btn btn-secondary" onclick="downloadRecipeVideo()" style="width: 100%;">
                            üîÑ Retry Download
                        </button>
                        <p style="font-size: 0.75rem; color: #ff4444; margin-top: 8px; text-align: center;">
                            ‚ùå Download failed: ${data.error || 'Unknown error'}
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Download error:', error);
                downloadStatus.innerHTML = `
                    <button class="btn btn-secondary" onclick="downloadRecipeVideo()" style="width: 100%;">
                        üîÑ Retry Download
                    </button>
                    <p style="font-size: 0.75rem; color: #ff4444; margin-top: 8px; text-align: center;">
                        ‚ùå Network error. Make sure the server is running.
                    </p>
                `;
            }
        }

        async function deleteRecipeVideo(filename) {
            if (!confirm('Delete this downloaded video? You can re-download it anytime.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/videos/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear local video/thumbnail from recipe
                    const recipe = recipes.find(r => r.id === currentRecipeId);
                    if (recipe) {
                        delete recipe.localThumbnail;
                        delete recipe.localVideo;
                        renderRecipes(); // Re-render to show original image
                    }
                    await checkForVideo(currentRecipeId);
                } else {
                    alert('Failed to delete video: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete video. Check console for details.');
            }
        }

        function changeWeek(direction) {
            currentWeekOffset += direction;
            saveData(); // Persist to localStorage
            renderCalendar();
        }

        function clearWeek() {
            if (confirm('Clear all meals for this week?')) {
                mealPlan = {};
                saveData(); // Persist to localStorage
                renderCalendar();
                updateMacroSummary();
            }
        }

        function updateMacroSummary() {
            const meals = Object.values(mealPlan);
            const mealCount = meals.length;
            
            // Calculate unique days that have meals
            const daysWithMeals = new Set();
            Object.keys(mealPlan).forEach(slotKey => {
                const dateKey = slotKey.split('-').slice(0, 3).join('-'); // Extract YYYY-MM-DD
                daysWithMeals.add(dateKey);
            });
            const numDaysWithMeals = daysWithMeals.size || 1; // Avoid divide by zero
            
            // Calculate totals (macros are per serving, multiply by servingsCount)
            const totals = meals.reduce((acc, meal) => ({
                calories: acc.calories + (meal.calories * servingsCount),
                protein: acc.protein + (meal.protein * servingsCount),
                carbs: acc.carbs + (meal.carbs * servingsCount),
                fat: acc.fat + (meal.fat * servingsCount)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
            
            // Calculate daily averages (only for days that have meals planned)
            const avgCalories = mealCount > 0 ? Math.round(totals.calories / numDaysWithMeals) : 0;
            const avgProtein = mealCount > 0 ? Math.round(totals.protein / numDaysWithMeals) : 0;
            const avgCarbs = mealCount > 0 ? Math.round(totals.carbs / numDaysWithMeals) : 0;
            const avgFat = mealCount > 0 ? Math.round(totals.fat / numDaysWithMeals) : 0;
            
            document.getElementById('totalCalories').textContent = avgCalories;
            document.getElementById('totalProtein').textContent = avgProtein + 'g';
            document.getElementById('totalCarbs').textContent = avgCarbs + 'g';
            document.getElementById('totalFat').textContent = avgFat + 'g';
            document.getElementById('mealCount').textContent = `${mealCount} meal${mealCount !== 1 ? 's' : ''} across ${numDaysWithMeals} day${numDaysWithMeals !== 1 ? 's' : ''}`;
        }

        function updateServings() {
            const input = document.getElementById('servingsInput');
            servingsCount = parseInt(input.value) || 1;
            if (servingsCount < 1) servingsCount = 1;
            if (servingsCount > 20) servingsCount = 20;
            input.value = servingsCount;
            saveData(); // Persist to localStorage
            
            // Update the display to show we're planning for X people
            updateMacroSummary();
        }

        async function generateShoppingList() {
            const meals = Object.values(mealPlan);
            
            if (meals.length === 0) {
                alert('No meals planned yet! Drag recipes onto the calendar first.');
                return;
            }
            
            // Aggregate ingredients with normalization
            const ingredientMap = {};
            
            meals.forEach(meal => {
                meal.ingredients.forEach(ing => {
                    // Normalize the ingredient name
                    const normalizedName = normalizeIngredientName(ing.name);
                    const key = normalizedName.toLowerCase().replace(/\s+/g, '_');
                    
                    if (!ingredientMap[key]) {
                        ingredientMap[key] = {
                            name: normalizedName,
                            amount: 0,
                            unit: ing.unit,
                            meals: []
                        };
                    }
                    
                    // Multiply by servings count only if perServing is true
                    const multiplier = ing.perServing !== false ? servingsCount : 1;
                    ingredientMap[key].amount += ing.amount * multiplier;
                    if (!ingredientMap[key].meals.includes(meal.name)) {
                        ingredientMap[key].meals.push(meal.name);
                    }
                });
            });
            
            // Round amounts for display
            const ingredientsArray = Object.values(ingredientMap)
                .map(ing => ({
                    ...ing,
                    amount: Math.round(ing.amount * 10) / 10 // Round to 1 decimal
                }))
                .sort((a, b) => b.amount - a.amount);
            
            // Build summary
            const ingredientList = ingredientsArray
                .map(ing => `${ing.name}: ${ing.amount}${ing.unit}`)
                .join('\n');
            
            const summary = `
üõí SHOPPING LIST PREVIEW

üë• Cooking for: ${servingsCount} person${servingsCount > 1 ? 's' : ''}
üìä ${meals.length} meals planned

${ingredientList}

‚úÖ Send to Apple Reminders?`;
            
            if (confirm(summary)) {
                // Call API to add to reminders
                await sendToReminders(ingredientsArray);
                // Also add meals to the Meals list
                await sendMealsToReminders();
            }
        }

        async function sendToReminders(ingredients) {
            const btn = document.querySelector('.btn-primary');
            btn.textContent = '‚è≥ Sending...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/shopping-list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingredients: ingredients,
                        listName: 'Shopping List'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`üéâ Success!\n\n‚úÖ ${data.summary.successful} items added to Shopping List\nüìÖ ${Object.keys(mealPlan).length} meals added to Meals list\n\nCheck your Apple Reminders app!`);
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to add items'}`);
                }
                
            } catch (error) {
                alert(`‚ùå Error: ${error.message}\n\nMake sure the backend server is running:\npython3 server.py (or refresh the page)`);
            } finally {
                btn.textContent = 'üõí Generate Shopping List';
                btn.disabled = false;
            }
        }

        async function sendMealsToReminders() {
            const meals = Object.values(mealPlan);
            if (meals.length === 0) return;
            
            // Convert mealPlan to array with day and type info
            const mealsWithDetails = Object.entries(mealPlan).map(([key, meal]) => {
                // Key format is "YYYY-MM-DD-lunch" or "YYYY-MM-DD-dinner"
                // Split from the end to get the meal type
                const lastDashIndex = key.lastIndexOf('-');
                const dateKey = key.substring(0, lastDashIndex);
                const mealType = key.substring(lastDashIndex + 1);
                
                const date = new Date(dateKey);
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dayName = days[date.getDay()];
                
                // Strip emoji from name since it's already included
                const nameWithoutEmoji = meal.name.replace(/^[^\w\s]+\s*/, '');
                
                return {
                    name: nameWithoutEmoji,
                    emoji: meal.emoji || 'üçΩÔ∏è',
                    day: dayName,
                    type: mealType
                };
            });
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/meals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        meals: mealsWithDetails,
                        listName: 'Meals',
                        servings: servingsCount
                    })
                });
                
                const data = await response.json();
                console.log('Meals added to reminders:', data);
                
            } catch (error) {
                console.error('Error adding meals to reminders:', error);
            }
        }

        // Clear all reminders from Apple Reminders
        async function clearAllReminders() {
            if (!confirm('Clear all items from Apple Reminders?\n\nThis will delete everything from:\n‚Ä¢ üõí Shopping List\n‚Ä¢ üìÖ This Week\'s Meals\n\nThis cannot be undone.')) {
                return;
            }

            const btn = document.querySelector('.btn-secondary[onclick="clearAllReminders()"]');
            const originalText = btn.textContent;
            btn.textContent = 'üßπ Clearing...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/reminders/clear-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const totalDeleted = data.summary?.totalDeleted || 0;
                    alert(`‚úÖ Reminders cleared!\n\nüóëÔ∏è ${totalDeleted} items deleted from:\n‚Ä¢ üõí Shopping List\n‚Ä¢ üçΩÔ∏è Meals`);
                } else {
                    alert(`‚ùå Error: ${data.error || 'Failed to clear reminders'}`);
                }

            } catch (error) {
                alert(`‚ùå Error: ${error.message}\n\nMake sure the backend server is running:\npython3 server.py`);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Random Meal Plan Generator
        function generateRandomMealPlan() {
            // Check if there's already a meal plan
            const existingMeals = Object.keys(mealPlan).length;
            if (existingMeals > 0) {
                if (!confirm(`You already have ${existingMeals} meals planned. Generate a new random plan? This will only fill empty slots.`)) {
                    return;
                }
            }
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
            
            // Create a copy of recipes to avoid modifying original
            let availableRecipes = [...recipes];
            
            // Shuffle recipes for randomness
            for (let i = availableRecipes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableRecipes[i], availableRecipes[j]] = [availableRecipes[j], availableRecipes[i]];
            }
            
            let recipeIndex = 0;
            let newMealsAdded = 0;
            
            // Fill each day with all meals
            days.forEach((dayName, index) => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + index);
                const dateKey = date.toISOString().split('T')[0];
                
                // Add breakfast (only if slot is empty)
                if (!mealPlan[`${dateKey}-breakfast`]) {
                    mealPlan[`${dateKey}-breakfast`] = availableRecipes[recipeIndex % availableRecipes.length];
                    recipeIndex++;
                    newMealsAdded++;
                }
                
                // Add lunch (only if slot is empty)
                if (!mealPlan[`${dateKey}-lunch`]) {
                    mealPlan[`${dateKey}-lunch`] = availableRecipes[recipeIndex % availableRecipes.length];
                    recipeIndex++;
                    newMealsAdded++;
                }
                
                // Add dinner (only if slot is empty)
                if (!mealPlan[`${dateKey}-dinner`]) {
                    mealPlan[`${dateKey}-dinner`] = availableRecipes[recipeIndex % availableRecipes.length];
                    recipeIndex++;
                    newMealsAdded++;
                }
                
                // Add snacks (only if slot is empty)
                if (!mealPlan[`${dateKey}-snacks`]) {
                    mealPlan[`${dateKey}-snacks`] = availableRecipes[recipeIndex % availableRecipes.length];
                    recipeIndex++;
                    newMealsAdded++;
                }
            });
            
            saveData(); // Persist to localStorage
            renderCalendar();
            updateMacroSummary();
            
            const totalMeals = Object.keys(mealPlan).length;
            
            if (newMealsAdded === 0) {
                alert(`‚úÖ Your week is already fully planned!\n\nüìä ${totalMeals} meals total\nüóëÔ∏è Click Clear to start over with a new random plan`);
            } else {
                alert(`üé≤ Random meal plan generated!\n\n‚úÖ ${newMealsAdded} new meals added\nüìä ${totalMeals} total meals planned\nüë• Serving ${servingsCount} person${servingsCount > 1 ? 's' : ''}\n\nClick üõí Shopping List when you're ready!`);
            }
        }

        // Everyday Items List - Common staples to add to shopping list
        const commonGroceryItems = [
            { id: 'coke-zero', name: 'ü•§ Coke Zero 10 Pack', category: 'drinks' },
            { id: 'eggs', name: 'ü•ö Free Range Eggs 12pk', category: 'dairy' },
            { id: 'milk', name: 'ü•õ Full Cream Milk 2L', category: 'dairy' },
            { id: 'bread', name: 'üçû White Bread 650g', category: 'bakery' },
            { id: 'bananas', name: 'üçå Bananas 1kg', category: 'produce' },
            { id: 'chicken-breast', name: 'üçó Chicken Breast 500g', category: 'meat' },
            { id: 'pasta', name: 'üçù Spaghetti Pasta 500g', category: 'pantry' },
            { id: 'yogurt', name: 'ü•£ Greek Yogurt 1kg', category: 'dairy' },
            { id: 'butter', name: 'üßà Butter 250g', category: 'dairy' },
            { id: 'cheese', name: 'üßÄ Cheddar Cheese 250g', category: 'dairy' },
            { id: 'rice', name: 'üçö Basmati Rice 1kg', category: 'pantry' },
            { id: 'olive-oil', name: 'ü´í Olive Oil 500ml', category: 'pantry' },
            { id: 'garlic', name: 'üßÑ Garlic Bulb', category: 'produce' },
            { id: 'onions', name: 'üßÖ Brown Onions 1kg', category: 'produce' },
            { id: 'potatoes', name: 'ü•î Potatoes 2kg', category: 'produce' },
            { id: 'carrots', name: 'ü•ï Carrots 1kg', category: 'produce' },
            { id: 'lettuce', name: 'ü•¨ Iceberg Lettuce', category: 'produce' },
            { id: 'tomatoes', name: 'üçÖ Tomatoes 500g', category: 'produce' },
            { id: 'cucumber', name: 'ü•í Cucumber', category: 'produce' },
            { id: 'lemons', name: 'üçã Lemons 4pk', category: 'produce' },
            { id: 'avocado', name: 'ü•ë Avocado', category: 'produce' },
            { id: 'mince', name: 'ü•© Beef Mince 500g', category: 'meat' },
            { id: 'bacon', name: 'ü•ì Bacon 250g', category: 'meat' },
            { id: 'toilet-paper', name: 'üßª Toilet Paper 8pk', category: 'household' },
            { id: 'dish-liquid', name: 'üßº Dishwashing Liquid', category: 'household' },
            { id: 'paper-towels', name: 'üßΩ Paper Towels 4pk', category: 'household' },
            { id: 'washing-liquid', name: 'üß¥ Washing Liquid', category: 'household' },
            { id: 'laundry-powder', name: 'üß∫ Laundry Powder', category: 'household' },
            { id: 'shampoo', name: 'üß¥ Shampoo', category: 'personal' },
            { id: 'toothpaste', name: 'ü™• Toothpaste', category: 'personal' }
        ];

        let selectedGroceryItems = new Set();
        // customGroceryItems is already declared in the State section above

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Show/hide content
            if (tab === 'recipes') {
                document.getElementById('recipeList').style.display = 'block';
                document.getElementById('groceryList').style.display = 'none';
                renderRecipes();
            } else {
                document.getElementById('recipeList').style.display = 'none';
                document.getElementById('groceryList').style.display = 'block';
                renderGroceryList();
            }
        }

        function renderGroceryList(filter = '') {
            const list = document.getElementById('groceryList');
            const filtered = commonGroceryItems.filter(item => 
                item.name.toLowerCase().includes(filter.toLowerCase())
            );

            let html = `
                <div class="grocery-header">
                    <h3>üìã Everyday Items</h3>
                    <p>Common staples to add to your shopping list</p>
                </div>
                <div style="margin-bottom: 15px; text-align: center;">
                    <button class="btn btn-secondary" onclick="toggleManualEntry()" id="toggle-custom-btn" style="font-size: 0.8rem; width: 100%;">
                        ‚úèÔ∏è Add Custom Items
                    </button>
                </div>
                <div id="manual-entry-panel" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 10px; font-size: 0.9rem;">Add Custom Items</h4>
                    <div id="manual-entry-form"></div>
                    <button class="btn btn-primary" onclick="saveManualPrices()" style="width: 100%; margin-top: 10px;">
                        üíæ Add Items
                    </button>
                </div>
            `;

            // Add section header for preset items
            html += `
                <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">
                        üì¶ Common Items (${filtered.length})
                    </h4>
                </div>
            `;

            if (filtered.length === 0) {
                html += '<div style="text-align: center; color: #999; padding: 20px;">No items found</div>';
            } else {
                html += filtered.map(item => {
                    const isSelected = selectedGroceryItems.has(item.id);
                    
                    return `
                        <div class="grocery-item ${isSelected ? 'selected' : ''}" 
                             onclick="toggleGroceryItem('${item.id}')"
                             data-id="${item.id}">
                            <h4>${item.name}</h4>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                ${isSelected ? '‚úÖ Added to list' : 'üëÜ Click to add'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            html += `
                <div class="grocery-actions">
                    <button class="btn-grocery" onclick="addSelectedGroceriesToShoppingList()" 
                            ${selectedGroceryItems.size === 0 ? 'disabled' : ''}>
                        üìã Add ${selectedGroceryItems.size} item${selectedGroceryItems.size !== 1 ? 's' : ''} to Shopping List
                    </button>
                </div>
            `;

            list.innerHTML = html;
        }

        function toggleGroceryItem(id) {
            console.log('Toggle item:', id, 'Current selected:', Array.from(selectedGroceryItems));
            if (selectedGroceryItems.has(id)) {
                selectedGroceryItems.delete(id);
            } else {
                selectedGroceryItems.add(id);
            }
            console.log('After toggle:', Array.from(selectedGroceryItems));
            renderGroceryList(document.getElementById('searchInput').value);
        }

        // Note: refreshPrices function removed - now just a simple everyday items list

        function toggleManualEntry() {
            const panel = document.getElementById('manual-entry-panel');
            const btn = document.getElementById('toggle-custom-btn');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                renderManualEntryForm();
                if (btn) btn.innerHTML = '‚úï Close Custom Items';
            } else {
                panel.style.display = 'none';
                if (btn) btn.innerHTML = '‚úèÔ∏è Add Custom Items';
            }
        }

        function renderManualEntryForm() {
            const form = document.getElementById('manual-entry-form');
            form.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.8rem; display: block; margin-bottom: 5px;">Item Name</label>
                    <input type="text" id="custom-item-name" placeholder="e.g., Coffee Beans" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 0.8rem; display: block; margin-bottom: 5px;">Category</label>
                    <select id="custom-item-category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
                        <option value="produce">ü•¨ Produce</option>
                        <option value="dairy">ü•õ Dairy</option>
                        <option value="meat">üçó Meat</option>
                        <option value="pantry">üçö Pantry</option>
                        <option value="drinks">ü•§ Drinks</option>
                        <option value="bakery">üçû Bakery</option>
                        <option value="household">üßª Household</option>
                        <option value="personal">üß¥ Personal Care</option>
                        <option value="other">üì¶ Other</option>
                    </select>
                </div>
                ${customGroceryItems.length > 0 ? `
                    <div style="margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                        <label style="font-size: 0.8rem; display: block; margin-bottom: 8px;">Your Custom Items:</label>
                        ${customGroceryItems.map((item, index) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 5px;">
                                <span>${item.name}</span>
                                <button onclick="deleteCustomItem(${index})" style="background: #ff4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.75rem; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        function saveManualPrices() {
            const nameInput = document.getElementById('custom-item-name');
            const categoryInput = document.getElementById('custom-item-category');
            
            if (!nameInput || !categoryInput) {
                console.error('Form elements not found');
                return;
            }
            
            const name = nameInput.value.trim();
            const category = categoryInput.value;
            
            console.log('Saving item:', { name, category });
            
            if (!name) {
                alert('Please enter an item name in the field above');
                nameInput.focus();
                return;
            }
            
            // Check for duplicates
            const exists = customGroceryItems.find(item => 
                item.name.toLowerCase() === name.toLowerCase()
            );
            
            if (exists) {
                alert(`"${name}" is already in your custom items!`);
                return;
            }
            
            const newItem = {
                id: 'custom-' + Date.now(),
                name: name,
                category: category
            };
            
            customGroceryItems.push(newItem);
            commonGroceryItems.push(newItem);
            
            localStorage.setItem('customGroceryItems', JSON.stringify(customGroceryItems));
            
            // Clear and close
            nameInput.value = '';
            document.getElementById('manual-entry-panel').style.display = 'none';
            const btn = document.getElementById('toggle-custom-btn');
            if (btn) btn.innerHTML = '‚úèÔ∏è Add Custom Items';
            
            renderGroceryList();
            
            alert(`‚úÖ "${name}" added to your items!`);
        }

        function deleteCustomItem(index) {
            const item = customGroceryItems[index];
            customGroceryItems.splice(index, 1);
            
            const commonIndex = commonGroceryItems.findIndex(i => i.id === item.id);
            if (commonIndex > -1) {
                commonGroceryItems.splice(commonIndex, 1);
            }
            
            localStorage.setItem('customGroceryItems', JSON.stringify(customGroceryItems));
            renderManualEntryForm();
            renderGroceryList();
        }

        function loadManualPrices() {
            // Load custom items on init
            customGroceryItems.forEach(item => {
                if (!commonGroceryItems.find(i => i.id === item.id)) {
                    commonGroceryItems.push(item);
                }
            });
        }
        
        async function addSelectedGroceriesToShoppingList() {
            const items = Array.from(selectedGroceryItems).map(id => 
                commonGroceryItems.find(item => item.id === id)
            );

            let results = [];
            let successful = 0;
            let failed = 0;

            for (const item of items) {
                const title = `üìã ${item.name}`;
                
                try {
                    // Add to Apple Reminders Shopping List
                    const response = await fetch(`${API_BASE_URL}/api/shopping`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            items: [title]
                        })
                    });
                    
                    if (response.ok) {
                        results.push(`‚úÖ ${item.name}`);
                        successful++;
                    } else {
                        results.push(`‚ùå ${item.name}`);
                        failed++;
                    }
                } catch (error) {
                    console.error('Error adding item:', error);
                    results.push(`‚ùå ${item.name}`);
                    failed++;
                }
            }

            alert(`Added ${successful} item${successful !== 1 ? 's' : ''} to Shopping List!${failed > 0 ? ` (${failed} failed)` : ''}\n\n${results.join('\n')}`);
            
            // Clear selections
            selectedGroceryItems.clear();
            renderGroceryList();
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Load custom items
        loadManualPrices();

        // Update search to work with both tabs (after init)
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const activeTab = document.querySelector('.tab-btn.active').id === 'tab-recipes' ? 'recipes' : 'groceries';
            if (activeTab === 'recipes') {
                renderRecipes(e.target.value);
            } else {
                renderGroceryList(e.target.value);
            }
        });
    </script>
</body>
</html>